# Nginx 配置指令的执行顺序

Nginx 请求的处理阶段有11个，其中最常见的三个阶段按时间序为：rewrite 阶段、access 阶段、content 阶段。所有 Nginx 模块提供的配置指令一般只会注册并运行在其中某一个处理阶段。比如 set 指令运行在 rewrite 阶段，echo 指令运行在 content 阶段。指令在配置文件中出现的顺序并不代表执行顺序，而要看指令所属的模块属于哪个阶段。ngx_rewrite 模块的几乎全部指令都运行在 rewrite 阶段。但有的指令不关联任何处理阶段，这类配置指令基本都是“声明性的”，不直接产生动作或过程。

有的配置指令在不同的配置块中使用时，执行的时机也不一样。比如 set 指令用在 location 配置块中时，在当前请求的 rewrite 阶段运行，如果用在 server 配置块中，则会运行在更早的 server-rewrite 阶段。

如果两个模块的指令都在同一个阶段运行，则它们的执行顺序是不确定的，一般依赖它们的加载顺序（但也有例外情况），要么是 A 模块的所有指令先执行完，然后执行 B 模块的指令，要么是等 B 模块的指令先执行完，再执行 A 模块的指令。用户最好不要依赖这种不确定的执行顺序。 