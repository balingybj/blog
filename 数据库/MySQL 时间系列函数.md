# MySQL 时间系列函数

最近查询数据库，发现对 MySQL 的时间函数不是太熟悉，每次都要现查现用，还要问同事，这里做一个比较全面的总结，便于后续检索。

## 日期和时间

### 获取当前   UTC   日期和时间  `UTC_TIMESTAMP`、`UTC_TIMESTAMP([fsp])`

`UTC_TIMESTAMP` 可以返回当前 UTC 时间，根据上下文环境为字符串还是数字返回格式为 `YYYY-MM-DD hh:mm:ss` 的字符串，或者格式为 `YYYYMMMDDhhmmss` 的整数。

```mysql
> select UTC_TIMESTAMP, UTC_TIMESTAMP + 0;
+---------------------+-------------------+
| UTC_TIMESTAMP       | UTC_TIMESTAMP + 0 |
+---------------------+-------------------+
| 2019-06-19 06:39:59 |    20190619063959 |
+---------------------+-------------------+
```

`UTC_TIMESTAMP + 0 ` 强制将上下文环境设为数字，因为只有数字才能和数字相加。

`UTC_TIMESTAMP` 函数还可以接受一个参数 `fsp` 指定比秒更小的精度，参数 `fsp` 的范围为 0~6，表示精度为 10 的 `fsp` 次方之一秒，也就是零点几秒，注意不要把它误解为毫秒或者微秒了。

```
mysql> select UTC_TIMESTAMP(7);
ERROR 1426 (42000): Too-big precision 7 specified for 'utc_timestamp'. Maximum is 6.

mysql> select UTC_TIMESTAMP(1),UTC_TIMESTAMP(2),UTC_TIMESTAMP(3);
+-----------------------+------------------------+-------------------------+
| UTC_TIMESTAMP(1)      | UTC_TIMESTAMP(2)       | UTC_TIMESTAMP(3)        |
+-----------------------+------------------------+-------------------------+
| 2019-06-19 06:46:02.1 | 2019-06-19 06:46:02.10 | 2019-06-19 06:46:02.108 |
+-----------------------+------------------------+-------------------------+
```

比如上面示例中的 `2019-06-19 06:46:02.1`，小数点后的 1 表示 0.1 秒，`2019-06-19 06:46:02.10` 小数点后的 10 表示 0.10秒，`2019-06-19 06:46:02.108` 小数点后的 108 表示 0.108 秒。

数字上下环境也一样：

```mysql
mysql> select UTC_TIMESTAMP(4) + 0, UTC_TIMESTAMP(5) + 0, UTC_TIMESTAMP(6) + 0;
+----------------------+----------------------+-----------------------+
| UTC_TIMESTAMP(4) + 0 | UTC_TIMESTAMP(5) + 0 | UTC_TIMESTAMP(6) + 0  |
+----------------------+----------------------+-----------------------+
|  20190619065102.3711 | 20190619065102.37110 | 20190619065102.371106 |
+----------------------+----------------------+-----------------------+
```

同系列函数：`UTC_DATE`、`UTC_TIME([fsp])`， 和 `UTC_TIMESTAMP` 类似，不过一个只有日期部分，一个只有时间部分。

```mysql
mysql> SELECT UTC_DATE(), UTC_DATE() + 0;
+------------+----------------+
| UTC_DATE() | UTC_DATE() + 0 |
+------------+----------------+
| 2019-06-19 |       20190619 |
+------------+----------------+

mysql> SELECT UTC_TIME, UTC_TIME(1), UTC_TIME(2), UTC_TIME(3);
+----------+-------------+-------------+--------------+
| UTC_TIME | UTC_TIME(1) | UTC_TIME(2) | UTC_TIME(3)  |
+----------+-------------+-------------+--------------+
| 09:17:50 | 09:17:50.5  | 09:17:50.55 | 09:17:50.557 |
+----------+-------------+-------------+--------------+
```



## 时间戳相关

### UNIX 时间戳  `UNIX_TIMESTAMP`、`UNIX_TIMESTAMP([data])`

`UNIX_TIMESTAMP()` 返回从 UTC 时间 `1970-01-01 00:00:00` 后经过的秒数。`UNIX_TIMESTAMP()` 有一个可选的 date 参数，该参数表示一个时间点，`UNIX_TIMESTAMP()` 会根据当前会话的时区来理解该 date 参数表示的时间，并将其转成 Unix 时间戳。date 参数可以为 `DATE`、`DATETIME` 或者 `TIMESTAMP` 字符串，或者格式为 `YYMMDD`、`YYMMDDhhmmss`、`YYYYMMDD` 或者 `YYYYMMDDhhmmss` 格式的整数。如果 date 参数中有 time 部分，则还可以提供小数点后的部分。

```mysql
mysql> SELECT UNIX_TIMESTAMP('1970-01-01 08:00:00');
+---------------------------------------+
| UNIX_TIMESTAMP('1970-01-01 08:00:00') |
+---------------------------------------+
|                                     0 |
+---------------------------------------+
```

UNIX 时间戳表示从 UTC 时间 `1970-01-01 00:00:00` 后经过的秒数，而且 `UNIX_TIMESTAMP()` 会根据当前会话的时区信息来理解 date 参数，而我们全国都是用的北京时间（东八区时间），我们接触到的软件环境也一般为东八区。所以上面的测试中，我们的会话环境为东八区，date 参数为 `1970-01-01 08:00:00`(注意是8点)， `UNIX_TIMESTAMP()` 将该参数理解为北京时间 `1970-01-01 08:00:00`，转成 UTC 时间为 `1970-01-01 00:00:00` ，与  UTC 时间 `1970-01-01 00:00:00` 相隔 0 秒，所以得到 UNIX 时间戳为 0。

```mysql
mysql> SELECT UNIX_TIMESTAMP('2019-06-19 16:36:30'),UNIX_TIMESTAMP(20190619163630);
+---------------------------------------+--------------------------------+
| UNIX_TIMESTAMP('2019-06-19 16:36:30') | UNIX_TIMESTAMP(20190619163630) |
+---------------------------------------+--------------------------------+
|                            1560933390 |                     1560933390 |
+---------------------------------------+--------------------------------+

mysql> SELECT UNIX_TIMESTAMP('2019-06-19 16:36:30.123'),UNIX_TIMESTAMP(20190619163630.456);
+-------------------------------------------+------------------------------------+
| UNIX_TIMESTAMP('2019-06-19 16:36:30.123') | UNIX_TIMESTAMP(20190619163630.456) |
+-------------------------------------------+------------------------------------+
|                            1560933390.123 |                     1560933390.456 |
+-------------------------------------------+------------------------------------+

mysql> SELECT UNIX_TIMESTAMP('19-06-19 16:36:30'),UNIX_TIMESTAMP(190619163630);
+-------------------------------------+------------------------------+
| UNIX_TIMESTAMP('19-06-19 16:36:30') | UNIX_TIMESTAMP(190619163630) |
+-------------------------------------+------------------------------+
|                          1560933390 |                   1560933390 |
+-------------------------------------+------------------------------+
```

### UNIX 时间戳  to 时间 `FROM_UNIXTIME(unix_timestamp [, format])`

`FROM_UNIXTIME` 函数可以将一个 UNIX 时间戳转成 `YYYY-MM-DD hh:mm:ss` 格式的时间字符串，或者格式为 `YYYYMMDDhhmmss.uuuuuu` 的数字，或者指定格式的返回。返回为字符串或者数字，取决于上下文环境。

```mysql
mysql> SELECT FROM_UNIXTIME(0), FROM_UNIXTIME(1560933390);
+---------------------+---------------------------+
| FROM_UNIXTIME(0)    | FROM_UNIXTIME(1560933390) |
+---------------------+---------------------------+
| 1970-01-01 08:00:00 | 2019-06-19 16:36:30       |
+---------------------+---------------------------+

mysql> SELECT FROM_UNIXTIME(1560933390.123) + 0;
+-----------------------------------+
| FROM_UNIXTIME(1560933390.123) + 0 |
+-----------------------------------+
|                20190619163630.123 |
+-----------------------------------+
```

`FROM_UNIXTIME` 返回的时间信息依赖于当前会话的时区信息。本次测试会话的时区为东八区，所以 UNIX 时间戳 0 （即 UTC 时间 `1970-01-01 00:00:00`）被转换成东八区时间 `1970-01-01 08:00:00`。

`FROM_UNIXTIME` 第二个参数 format 可以指定返回的的格式，能用的 `format` 同函数 `DATE_FORMAT`。

```mysql
mysql> SELECT FROM_UNIXTIME(1560933390, '%Y-%m-%d %W');
+------------------------------------------+
| FROM_UNIXTIME(1560933390, '%Y-%m-%d %W') |
+------------------------------------------+
| 2019-06-19 Wednesday                     |
+------------------------------------------+
```

