# 表达式

表达式是由运算符+操作数组成的序列，表示一项计算任务。

表达式的计算会产生一个结果（例如，1+2 产生一个结果 3)，也可能会产生其他副作用（例如，`std::printf("%4", 4)` 的副作用是在标准输出打印一个字符 `4`）。

## 概述

- 表达式的返回值可以分为：左值（lvalue）、右值（rvalue）、泛左值、纯右值（prvalue）、亡值（xvalue）
- 参数和子表达式的求值顺序指定了获取中间结果所用的顺序

## 运算符

既然表达式由运算符合操作数组成，先来看看有多少种表达式。

- 普通运算符
    - 赋值运算符
        - `a = b`、`a += b`、`a -= b`、`a *= b`、`a /= b`、`a %= b`、`a &= b`、`a |= b`、`a ^= b`、`a >>= b`
    - 增量运算符（自增运算符）、减量运算符（自减运算符）
        - `++a`、`--a`、`a++`、`a--`
    - 算术运算符
        - `+a`、`-a`、
        - `a + b`、`a - b`、`a * b`、`a / b`、`~a`、`a & b`、`a | b`、`a ^ b`、`a << b`、`a >> b`
    - 逻辑运算符
        - `!a`
        - `a && b`、`a || b`
    - 比较运算符
        - `a == b`、`a != b`、`a < b`、`a > b`、`a <= b`、`a >= b`、`a <=> b`
    - 成员访问
        - `a[b]`、`*a`、`&a`、`a->b`、`a->*b`、`a.*b`
    - 其他
        - `a(...)`、`a, b`、`? :`
- 特殊运算符
    - `static_cast` 将一种类型转换成另外一种相关类型
    - `dynamic_cast`  在继承层级中相互转换
    - `const_cast` 添加或移除 cv 限定符
    - `reinterpret_cast` 将一种类型转换为另一种不相关的类型
    - `C 风格转型` 通过混合使用 static_cast、const_cast、reinterpret_cast 将一种类型转换成另一种类型
    - `new` 创建具有动态存储期的对象
    - `delete` 销毁先前由 new 表达式创建的对象，并释放对应存储空间
    - `sizeof` 查询类型大小
    - `sizeof...` 查询参数包大小（since C++11）
    - `typeid` 查询类型的类型信息
    - `noexcept` 检查表达式释能抛出异常（since C++11）
    - `alignof` 查询类型的对齐要求（since C++11）

运算符优先级定义了操作符绑定到其实参的顺序。

可选表示是一些操作符的替代拼写。

操作符重载，允许用户指定某些运算符应用到用户自定义类时的行为。

### 转换

- 标准转换，从一种类型到另一种类型的转换
- const_cast 转换
- static_cast 转换
- dynamic_cast 转换
- reinterpret_cast 转换
- 显式转换，使用 C 风格转换表示法和函数表示法
- 用户定义转换，用户为定义类定义的转换

### 内存分配

- new 表达式，动态分配内存
- delete 表达式，动态回收内存

### 其他

- 常量表达式，在编译期求值，并可以在编译上下文（模板实参，数组大小，等等）中使用
- sizeof 表达式
- alignof 表达式
- typeid 表达式
- throw 表达式

## 初等表达式

任何运算符的操作数可以是其他表达式或初等表达式（例如，在表达式  `1+2*3` 中，运算符 `+` 的操作数为子表达式 `2*3` 和初等表达式 `1`）。

初等表达式包括以下六种：

- 字面量（例如，数字 `2`，字符串“Hello, world”）
- 经过适当声明的无限定标识符（例如 `n`,`cout`）
- 经过适当声明的有限定标识符（例如，std::string::npos）
- Lambda 表达式（since C++11）
- 折叠表达式（since C++17）
- require 表达式（since C++20）

括号中的任何表达式也都被归类为初等表达式：这样可以保证括号的优先级高于任何运算符。圆括号可以保持值、类型和智类别不变

### 字面量

字面量是 C++ 源码中用于表示常量值的文字。

- 整数字面量包括：十进制整数、八进制整数、十六进制整数、二进制整数
- 字符字面量是下列类型之一的字符：
    - `char` 或 `char_t`
    - `char16_t` 或 `char32_t`（since C++11）
    - `char8_t`（since C++20）
- 浮点数字面量包括 `float`、`double`、`long double` 类型的值
- 字符串字面量是下列类型之一的字符序列：
    - `const char[]` 或 `const wchar_t[]`
    - `const char16_t[]` 或 `const char32_t[]`（since C++11）
    - `const char8_t[]`（since C++20）
- 布尔字面量是 `bool` 类型的值，包括 `true` 和 `false`
- `nullptr` 是指针字面量，表示一个空指针（since C++11）
- 用户自定义字面量，用户自定义类型的常量值（since C++11）

## 不求值表达式

运算符 typeid、sizeof、noexcept 或 decltype（since C++）的操作数属于不求值表达式（一个例外情况是，typeid 的操作数为多台 glvalues 时）。因为这些操作符只查询操作数在编译时的属性。例如，`std::size_t n = sizeof(std::cout << 42)` 不会在控制台产生任何输出，这里的操作数 `std::cout << 42` 属于不求值表达式，sizeof 仅仅需要在编译时知道 `std::cout << 42`  表达式返回值的大小。

不求值表达式虽然是一个表达式的操作数，但也属于一个*完整表达式*（例如，`sizeof(T())` 也需要 T::~() 可访问）。（since C++14）

require 表达式也属于不求值表达式。（since C++20）

即使在不求值表达式中，对*立即函数*的调用也总是求值的。（since C++20）

## 弃值表达式

弃值表达式是仅用来实施其副作用的表达式。从该表达式得到的值被直接抛弃。这种表达式包括任何表达式语句的完整表达式，逗号运算符左侧的操作数，以及转型到 `void` 类型的操作数。

弃值表达式得到的值永远不会进行由数组到指针和函数到指针的转换。当且仅当表达式为 volatile 限定的泛左值，并具有以下形式之一（必须为其内建含义，可以有括号）时，进行左值到右值的转换：

- 标识表达式
- 数组下标表达式
- 类成员访问表达式
- 简介寻址
- 成员指针操作
- 条件表达式，并且第二和第三操作数都是这些表达式之一
- 逗号表达式，并且右操作数是这些表达式之一

另外，如果左值是 volatile 限定的类类型，则要求用 volatile 复制构造函数来初始化作为结果的右值临时量。

如果表达式（经过可能会发生的左值到右值的转换后）是非 void 纯右值，则进行*临时量实质化*。（since C++17）

当表达式丢弃了声明为 *`[[nodiscard]]`* 的值，但又它不是转型为 `void` 时，编译器可以发出警告。（since C++17）

