# 替换文本宏

> 本文翻译自[Replacing text macros](https://en.cppreference.com/w/cpp/preprocessor/replace)

预处理器支持文本宏替换。还支持类似于函数的文本宏替换。

## 语法

```c++
#define 标识符 替换列表（可选）          (1)
#define 标识符(行参) 替换列表（可选）     (2)
#define 标识符(行参,...) 替换列表（可选） (3) (since C++11)
#define 标识符(...) 替换列表（可选）     (4) (since C++11)
#undef 标识符                         (5)
```

## 解释

### `#define` 指令

`#define` 指令将 *标识符* 定义为宏，即指示编译器将后续出现的所有该 *标识符* 替换为 *替换列表*，后者可以被进一步处理。如果标识符已经被定义为任何类型的宏，除非定义相同，否则程序是病态的。

#### 仿对象宏

仿对象宏将所有相关的 *标识符* 替换为 *替换列表*。`#define` 指令的版本 (1) 行为与此完全相同。

#### 仿函数宏

仿函数宏用 *替换列表* 替换 *标识符*，可以接收一些实参，这些实参会替换掉 *替换列表* 中对应的 *形参*。

仿函数宏调用的语法类似于函数调用的语法：每个宏名实例后跟一个 `(` 作为下个预处理标记，所引入的标记序列将会被替换为 *替换列表*。该序列以匹配到的 `)` 结束，序列中间出现的括号对会被跳过。

对于 `#define` 指令的版本（2），实参数量必须与宏定义中的形参数量相同。对于版本（3，4），实参数量必须多余（C++20以前）不少于（C++20 起）形参数量（这个数量不包括...）。否则程序不是良构的。如果标识符未使用函数语法，例如，标识符后面没有括号，则完全不被替换。

`#define` 指令的版本（2）定义简单的仿函数宏。

`#define` 指令的版本（3）定义有可变数量实参的仿函数宏，额外的实参（称为变量实参）可以通过 `__VA_ARGS__` 标识符访问，该标识符会被实参替换，并提供要替换的标识符。

`#define` 指令的版本（4）定义一个有可变数量实参但是没有常规实参的仿函数宏。实参（称为变量实参）可以通过 `__VA_ARGS__` 标识符访问，该标识符会被实参替换，并提供要替换的标识符。

自 C++20 开始，`#define` 版本（3，4）中，*替换列表* 可以包含标记序列 `__VA_OPT__(content)`，如果 `__VA_ARGS__` 非空，则 `__VA_OPT__(content)` 会展开为 content，否则不展开成任何内容。

```c++
#define F(...) f(0 __VA_OPT__(,) __VA_ARGS__)
#define G(X, ...) f(0, X __VA_OPT__(,) __VA_ARGS__)
#define SDEF(sname, ...) S sname __VA_OPT__(= { __VA_ARGS__ })
F(a, b, c) // 替换为 f(0, a, b, c)，__VA_ARGS__ 不为空，__VA_OPT__(,)展开成,
F()        // 替换为 f(0) __VA_ARGS__ 为空，__VA_OPT__(,)不展开
G(a, b, c) // 替换为 f(0, a, b, c)
G(a, )     // 替换为 f(0, a)
G(a)       // 替换为 f(0, a)
SDEF(foo);       // 替换为 S foo;
SDEF(bar, 1, 2); // 替换为 S bar = { 1, 2 };
```

注意：如果仿函数实参中包含不被左右括号保护的逗号（常见与模板实参列表中，例如`assert(std::is_same_v<int, int>);` ，`BOOST_FOREACH(std::pair<int,int> p, m)`），逗号被解释为宏参数分隔符，并造成由于实参数量不匹配导致的编译失败。

### 保留宏名

包含标准库头文件的翻译单元不能使用 `#define` 或 `#undefine` 声明任何出现在标准库头文件中名称。

使用任何标准库的翻译单元不能使用 `#define` 或 `#undefine`  声明属于以下内容的名称：

- 关键词
- 有特殊含义的标识符（C++11 起）
- 任何标准属性标记（C++11 起）
- 除了可定义 likely 与 unlikely 为仿函数宏（C++20 起）

否则，行为未定义。

### `#` 与 `##` 运算符



































