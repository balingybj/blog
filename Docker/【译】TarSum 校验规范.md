>   本文翻译自 Docker 官方仓库文档[TarSum Checksum Specification](https://github.com/moby/moby/blob/master/pkg/tarsum/tarsum_spec.md)。该文档最后更新的时间为 2016 年，也不知道是否适用新版本的 Docker。反正也找不到其他资料，先翻译再说。

# TarSum 校验和规范

## 摘要

本文档描述了在文件系统层上计算 TarSum 校验和时使用的算法、对现有方法的需求、以及该技术的版本控制。

## 警告

这个校验和算法是为了使用模糊逻辑对文件树进行最优比较。

这不是加密认证，不应该被认为是安全的。

## 介绍

在 Docker 中，文件系统的传输是使用 tar 存档文件完成的。现实世界存在各种各样的 tar 序列化格式，关键之处在于给定一组来自通过 tar 存档文件的输入，保证得到一个可重复的校验和。传输的类型包括从一个注册中心传输到另一个注册中心，通过命令或 Docker 守护进程 API 保存或加载，将构建上下文从客户的传输到 Docker 守护进程，将一个容器的文件系统提交镜像。

>   译者注：这里说的“可重复的校验和”意思是对同样文件内容打包生成的 tar 存档文件，不管生成的 tar 格式怎么变化，必须保证产生的校验是一样的。

因为 tar 存档多用于传输，而不是用于保存，该算法的重点在于确保所保存的文件系统的完整性，同时维护一个确定性问责制。

## 目标读者

本文档概述了通过 tar 存档文件传输文件系统时使用的一致性校验和的计算方法。

对这些方法的审计是一个开放和迭代的过程。本文档应当适应源码的审查。最后，本文档是以后算法进一步改进和后续版本的起点。

## 概念

校验和机制必须保证文件系统的完整性，已经保证文件系统有效负载。

## 校验和算法概述

一个校验和机制必须定义以下操作和属性：

-   相关的哈希密码 - 用于校验每个文件内容负载和属性信息。
-   检验和列表 - 文件系统存档中的每个文件都有一个校验和，从该文件的内容负载和属性计算得出。最终的检验和在该列表上以特定的顺序计算得出。
-   版本 - 当算法慢慢适应需求变化，用版本来管理算法的行为。
-   存档被计算 - tar存档文件也要计算一个校验和。

## TarSum 检验码的组成元素

计算出的总和是一个文本串。总和中包含的元素包含了验证总和所需要的信息（TarSum 版本和使用的哈希密码）以及十六进制的期望校验和。

有两种分割符：

-   '+' 分割 TarSum 版本和哈希密码
-   ':' 分割计算机制和期望的哈希值

示例：

```
	"tarsum.v1+sha256:220a60ecd4a3c32c282622a625a54db9ba0ff55b5ba9c29c7064a2bc358b6a3e"
	|         |       \                                                               |
	|         |        \                                                              |
	|_version_|_cipher__|__                                                           |
	|                      \                                                          |
	|_calculation_mechanics_|______________________expected_sum_______________________|
```

## 版本

版本 [0] 用来适应不同的计算需求，以及保持逆向兼容性。

通用性算法将在 'Calculation' 中描述。

### Version0

只是 TarSum 的初始版本。

它在 TarSum 校验和字符串中对应的元素是`tarsum`。

### Version1

在 TarSum 校验和中对应的元素是`tarsum.v1`。

该版本的显著变化是：

-   在计算每个文件的校验和时排除文件信息头中的`mtime`
-   在计算文件的校验和时新包含了扩展属性（`xattrs`，也被视为`SCHILY.xattr.`prefixed Pax
    tar file info header）的键和值。

### VersionDev

除非用于验证校验和算法的改进，否则不要使用。

在 TarSum 校验和中对应的元素为`tarsum.dev`。

这是下个版本的浮动占位符和测试变更的基础。计算所用的方法在没通知的情况下会发生改变，该版本号只用于测试，而不用于生产环境。

## 哈希算法

计算机制中默认和标准的哈希算法为`sha256`。指在 FIPS 180-4 中定义的 SHA256 哈希算法。

虽然 TarSum 算法本身不局限于单一的哈希算法`sha256`，后续也添加了可选的哈希算法 [1]。可选的哈希算法的适用场景可能是面向未来的 TarSum 校验和格式，以及为文件系统校验和使用更快的密码哈希。

## 计算方法

### 需求

前面提到过，计算方法要考虑 tar 存档文件的生命周期。tar 存档并不是一个不可变的永久工件。否则依赖 tar 存档本身现成的散列密码校验和就足够可靠了。文件系统的 tar 存档作为 Docker 镜像的传输介质，当存档的内容呗提取出来时，存档就被丢弃了。所以，一致性验证项目，比如 tar 存档中的文件顺序和时间戳在接收到镜像后也会跟着改变。

### 过程

该方法一般是迭代的从存档流中读取 tar 信息头，不过这不是一个严格要求。

#### 文件

tar 存档中的每个文件都有其内容（headers and body）的单独校验，使用指定的关联散列密码。文件的有序头信息先被写入到校验和技术，然后是文件内容。

文件的校验和结果被添加到一个文件总和列表中。该总和被编码为一个十六进制摘要的字符串。另外，文件名和文件在存档中的位置作为特定排序的参考。

#### 头



































































